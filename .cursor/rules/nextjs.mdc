---
globs: **/app/**/*.tsx,**/api/**/*.ts
description: Next.js 16 开发规范与最佳实践
---

# Next.js 16 开发规范

## 项目结构

### App Router 结构
- 使用 Next.js 16 App Router（[app](mdc:src/app) 目录）
- 页面组件放在 `app` 目录下，使用 `page.tsx` 命名
- 布局组件使用 `layout.tsx`
- API 路由放在 `app/api` 目录下，使用 `route.ts` 命名

### 目录组织
```
src/
├── app/              # Next.js App Router
│   ├── api/         # API 路由
│   ├── layout.tsx   # 根布局
│   └── page.tsx     # 首页
├── components/      # React 组件
├── lib/             # 工具函数
└── store/           # 状态管理
```

## 客户端组件

### 'use client' 指令
- **必须**在需要客户端交互的组件顶部添加 `'use client'`
- 使用 Hooks、事件处理、浏览器 API 的组件需要此指令
- 参考：[page.tsx](mdc:src/app/page.tsx) 和 [ChatInterface.tsx](mdc:src/components/ChatInterface.tsx)

### 服务端组件优先
- 默认使用服务端组件（不添加 'use client'）
- 只在需要客户端功能时使用客户端组件
- 服务端组件可以导入客户端组件，反之不行

## API 路由

### 路由处理
- API 路由文件必须命名为 `route.ts`
- 导出命名函数：`GET`, `POST`, `PUT`, `DELETE` 等
- 使用 `NextRequest` 和 `NextResponse` 处理请求

### 示例结构
```typescript
import { NextRequest, NextResponse } from 'next/server';

export async function POST(request: NextRequest) {
  try {
    const body = await request.json();
    // 处理逻辑
    return NextResponse.json({ success: true });
  } catch (error) {
    return NextResponse.json(
      { error: 'Internal Server Error' },
      { status: 500 }
    );
  }
}
```

### 流式响应
- 使用 `ReadableStream` 实现流式响应
- 参考：[api/chat/route.ts](mdc:src/app/api/chat/route.ts) 中的流式处理

## 状态管理

### Zustand 集成
- 使用 Zustand 进行客户端状态管理
- 支持持久化存储：`persist` 中间件
- 参考：[useChatStore.ts](mdc:src/store/useChatStore.ts)

### 状态初始化
- 在客户端组件中使用 `useEffect` 初始化状态
- 使用 `persist.rehydrate()` 恢复持久化状态

## 样式规范

### Tailwind CSS
- 使用 Tailwind CSS 进行样式设计
- 使用 `cn()` 工具函数合并类名（来自 [utils.ts](mdc:src/lib/utils.ts)）
- 响应式设计使用 Tailwind 断点前缀

### 动画
- 使用 Framer Motion 实现动画效果
- 使用 `AnimatePresence` 处理组件进入/退出动画
- 参考：[ChatInterface.tsx](mdc:src/components/ChatInterface.tsx) 中的动画实现

## 性能优化

### 代码分割
- 使用动态导入（`dynamic import`）懒加载组件
- 使用 `React.lazy` 和 `Suspense` 实现代码分割

### 图片优化
- 使用 `next/image` 组件优化图片加载
- 配置适当的图片尺寸和格式

### 数据获取
- 服务端组件使用 `async/await` 直接获取数据
- 客户端组件使用 `fetch` 或 SWR/React Query
- 实现适当的缓存策略

## 环境变量

- 使用 `.env.local` 存储本地环境变量
- 客户端变量必须以 `NEXT_PUBLIC_` 前缀
- 服务端变量无需前缀，但不会暴露给客户端

## 类型安全

### TypeScript 配置
- 使用严格的 TypeScript 配置（[tsconfig.json](mdc:tsconfig.json)）
- 启用路径别名：`@/*` 映射到 `src/*`
- 使用 Next.js TypeScript 插件

### 类型定义
- API 路由定义请求和响应类型
- 使用 `NextRequest` 和 `NextResponse` 的类型推断

## 错误处理

### 错误边界
- 使用 `error.tsx` 文件处理路由错误
- 使用 `not-found.tsx` 处理 404 错误

### API 错误
- 返回适当的 HTTP 状态码
- 提供清晰的错误消息
- 记录错误日志

## 最佳实践

1. **SEO 优化**：使用 `<Metadata>` API 设置页面元数据
2. **路由保护**：在中间件或布局中实现认证
3. **国际化**：使用 Next.js i18n 功能（如需要）
4. **监控**：集成错误监控和性能分析工具
5. **测试**：为 API 路由和关键组件编写测试
