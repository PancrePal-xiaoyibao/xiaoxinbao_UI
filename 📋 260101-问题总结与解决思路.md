📋 问题总结与解决思路

🔍 当前问题

阿里云 DashScope 的 STT API 报错："input must contain file urls"

根本原因：
- 录音文件识别 API 只支持公网可访问的文件 URL
- 不支持 Base64 编码的音频
- 不支持直接上传二进制文件

---
💡 解决方案（按优先级排序）

⭐ 方案 1：使用浏览器原生 SpeechRecognition API（最简单）

优点：
- ✅ 无需后端 API
- ✅ 已经实现了（在普通聊天界面的小话筒按钮）
- ✅ 免费使用

缺点：
- ❌ 需要浏览器支持
- ❌ 准确率可能不如阿里云

实现方式：
// ChatInterface.tsx 已经实现了
const toggleNativeMic = async () => {
  // 使用浏览器原生 SpeechRecognition
};

---
⭐ 方案 2：配置阿里云 OSS + 文件 URL（推荐）

优点：
- ✅ 使用官方推荐方式
- ✅ 稳定可靠

缺点：
- ❌ 需要配置 OSS 服务
- ❌ 增加复杂度

实现步骤：
1. 创建 OSS Bucket（公共读权限）
2. 安装 SDK：
npm install ali-oss
3. 上传音频到 OSS：
import OSS from 'ali-oss';

const client = new OSS({
  region: 'oss-cn-hangzhou',
  accessKeyId: process.env.OSS_ACCESS_KEY_ID!,
  accessKeySecret: process.env.OSS_ACCESS_KEY_SECRET!,
  bucket: 'your-bucket-name',
});

// 上传音频文件
const result = await client.put('audio.wav', audioFile);
const fileUrl = result.url; // 获取公网 URL
4. 调用 STT API：
const response = await fetch('https://dashscope.aliyuncs.com/api/v1/services/audio/asr/transcription', {
  method: 'POST',
  headers: {
    'Authorization': `Bearer ${ALIBABA_API_KEY}`,
    'Content-Type': 'application/json',
    'X-DashScope-Async': 'enable', // 异步模式
  },
  body: JSON.stringify({
    model: 'paraformer-v2',
    input: {
      file_urls: [fileUrl], // 使用 OSS URL
    },
  }),
});
5. 轮询查询结果：
const taskId = data.output.task_id;

// 循环查询任务状态
while (true) {
  const result = await fetch(`https://dashscope.aliyuncs.com/api/v1/tasks/${taskId}`, {
    method: 'POST',
    headers: {
      'Authorization': `Bearer ${ALIBABA_API_KEY}`,
    },
  });

  const data = await result.json();
  if (data.output.task_status === 'SUCCEEDED') {
    // 获取识别结果
    const transcriptionUrl = data.output.results[0].transcription_url;
    const transcription = await fetch(transcriptionUrl).then(r => r.json());
    return transcription.transcripts[0].text;
  }

  await new Promise(resolve => setTimeout(resolve, 1000)); // 等待1秒
}

---
⭐ 方案 3：WebSocket 实时语音识别（最推荐）

优点：
- ✅ 低延迟（边说边识别）
- ✅ 适合对话场景
- ✅ 官方推荐

缺点：
- ❌ 需要使用阿里云 SDK（Java/Python）
- ❌ Next.js API Routes 不支持 WebSocket
- ❌ 需要改用独立服务器或使用 Serverless Function

实现方式：
- 使用阿里云 DashScope SDK（Python/Java）
- 部署独立的 WebSocket 服务器
- 或者使用 Vercel Edge Functions（支持 WebSocket）

---
⭐ 方案 4：使用其他 STT 服务（备选）

可选服务：
1. OpenAI Whisper API
  - 支持 Base64 和文件上传
  - 准确率高
  - 价格：$0.006 / 分钟
2. 腾讯云语音识别
  - 支持 REST API
  - 可能支持直接上传
3. 讯飞语音识别
  - 国内服务商
  - WebSocket 和 REST API 都支持

---
📚 参考资料

主人明天可以查看这些文档喵～

1. 阿里云录音文件识别 API
  - https://help.aliyun.com/zh/model-studio/paraformer-recorded-speech-recognition-restful-api
  - 注意：必须使用文件 URL
2. 阿里云实时语音识别（WebSocket）
  - https://help.aliyun.com/zh/model-studio/real-time-speech-recognition
  - 注意：需要使用 SDK
3. 阿里云 OSS 文档
  - https://help.aliyun.com/zh/oss
  - 如何创建 Bucket 和上传文件
4. OpenAI Whisper API
  - https://platform.openai.com/docs/guides/speech-to-text
  - 支持直接上传音频文件

---
🎯 浮浮酱的建议

短期方案（今晚）：
- 使用浏览器原生 SpeechRecognition API
- 已经实现了，可以直接使用
- 在普通聊天界面点击小话筒即可

长期方案（明天）：
- 推荐方案 2：配置 OSS + 文件 URL（最稳定）
- 或者 方案 3：使用 WebSocket 实时识别（体验最好）

---